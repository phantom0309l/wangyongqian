// Generated by LiveScript 1.4.0
(function(){
  var m1model, emmodel, m1vm, emvm;
  m1model = {
    $id: "m1",
    visible: false,
    sublock: false,
    deltmp: 0,
    misses: gon.misses,
    mistitle: "",
    miscontent: "",
    telpf: false,
    msgpf: false,
    tel_check: function(){
      m1vm.telpf = !m1vm.telpf;
    },
    msg_check: function(){
      m1vm.msgpf = !m1vm.msgpf;
    },
    init: function(){
      m1vm.mistitle = "";
      m1vm.miscontent = "";
    },
    missdel: function(miss){
      if (miss.id !== m1vm.deltmp) {
        alert("你正在进行一个危险的操作，你需要确认后重复操作方可生效");
        m1vm.deltmp = miss.id;
        return;
      }
      $.post("/man/opsmiss/del", {
        id: miss.id
      }, function(data, status){
        if (data === "fine") {
          m1vm.misses.remove(miss);
        }
      });
    },
    misssub: function(){
      if (!(m1vm.mistitle && m1vm.miscontent)) {
        alert("你在逗我?");
        return;
      }
      m1vm.sublock = true;
      $.post("/man/opsmiss/create", {
        title: m1vm.mistitle,
        content: m1vm.miscontent
      }, function(data, status){
        if (data) {
          alert("任务创建成功");
          m1vm.misses = data;
          m1vm.close_window();
          m1vm.sublock = false;
        }
      });
    },
    send2em: function(miss){
      emvm.rec(miss);
    },
    open_window: function(){
      m1vm.visible = true;
    },
    close_window: function(){
      m1vm.visible = false;
      m1vm.init();
    }
  };
  emmodel = {
    $id: "em",
    visible: false,
    sublock: false,
    miss: false,
    anchor: "audited",
    tskew: "",
    skew_to: "+",
    pg: [],
    sendway: "normal",
    pftype: "none",
    check_anchor: function(anchor){
      emvm.anchor = anchor;
    },
    check_sk2: function(skew){
      emvm.skew_to = skew;
    },
    check_sendway: function(sendway){
      emvm.sendway = sendway;
    },
    check_pftype: function(pftype){
      emvm.pftype = pftype;
    },
    execsub: function(){
      if (emvm.pg.length === 0 || !emvm.tskew || emvm.tskew.match(/[^\d]/)) {
        alert("不选用户组和合法日期偏移值还要归档任务，你逗我?");
        return;
      }
      $.post("/man/opsmiss/file", {
        mid: emvm.miss.id,
        anchor: emvm.anchor,
        time_skew: emvm.tskew,
        skew_to: emvm.skew_to,
        pg: emvm.pg.join(),
        sendway: emvm.sendway,
        pftype: emvm.pftype
      }, function(data, status){
        if (data === 'fine') {
          alert("任务归档成功");
          emvm.visible = false;
        }
      });
    },
    rec: function(miss){
      emvm.miss = miss;
      emvm.visible = true;
    },
    close_window: function(){
      emvm.visible = false;
    }
  };
  m1vm = avalon.define(m1model);
  emvm = avalon.define(emmodel);
}).call(this);
